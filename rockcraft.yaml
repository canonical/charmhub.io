name: charmhub-io
title: charmhub-io
version: '0.1'
summary: Rocked charmhub.io
description: |
  This is the rockcraft for the charmhub.io website.
base: bare
build-base: ubuntu@22.04
platforms:
  amd64:
    build-on:
    - amd64
    build-for:
    - amd64
parts:
  flask-framework/install-app:
    prime:
    - flask/app/.env
    - flask/app/app.py
    - flask/app/webapp
    - flask/app/templates
    - flask/app/static
    - flask/app/redirects.yaml
    - flask/app/security.txt
    - flask/app/robots.txt
    - flask/app/gunicorn.conf.py
    plugin: dump
    source: .
    organize:
      .env: flask/app/.env
      app.py: flask/app/app.py
      webapp: flask/app/webapp
      templates: flask/app/templates
      static: flask/app/static
      redirects.yaml: flask/app/redirects.yaml
      security.txt: flask/app/security.txt
      robots.txt: flask/app/robots.txt
      gunicorn.conf.py: flask/app/gunicorn.conf.py
    stage:
    - flask/app/.env
    - flask/app/app.py
    - flask/app/webapp
    - flask/app/templates
    - flask/app/static
    - flask/app/redirects.yaml
    - flask/app/security.txt
    - flask/app/robots.txt
    - flask/app/gunicorn.conf.py
  flask-framework/dependencies:
    plugin: python
    stage-packages:
    - python3.10-venv_ensurepip
    source: .
    python-packages:
    - gunicorn
    python-requirements:
    - requirements.txt
    build-environment:
    - PARTS_PYTHON_INTERPRETER: python3.10
  flask-framework/config-files:
    plugin: dump
    source: /snap/rockcraft/2599/share/rockcraft/extensions/flask-framework
    organize:
      gunicorn.conf.py: flask/gunicorn.conf.py
  flask-framework/statsd-exporter:
    build-snaps:
    - go
    source-tag: v0.26.0
    plugin: go
    source: https://github.com/prometheus/statsd_exporter.git
  flask-framework/runtime:
    plugin: nil
    override-build: mkdir -m 777 ${CRAFT_PART_INSTALL}/tmp
    stage-packages:
    - bash_bins
    - coreutils_bins
    - ca-certificates_data
  pebble:
    plugin: nil
    stage-snaps:
    - pebble/latest/stable
    override-prime: |-
      craftctl default
      mkdir -p var/lib/pebble/default/layers
      chmod 777 var/lib/pebble/default
    stage:
    - bin/pebble
run-user: _daemon_
services:
  flask:
    override: replace
    command: /bin/python3 -m gunicorn -c /flask/app/gunicorn.conf.py app:app
    startup: enabled
    after:
    - statsd-exporter
    user: _daemon_
  statsd-exporter:
    override: merge
    command: /bin/statsd_exporter --statsd.mapping-config=/statsd-mapping.conf --statsd.listen-udp=localhost:9125
      --statsd.listen-tcp=localhost:9125
    summary: statsd exporter service
    startup: enabled
    user: _daemon_
