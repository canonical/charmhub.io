{% extends 'publisher/publisher_layout.html' %}

{% block title %}Edit solution - {{ solution.title }}{% endblock %}
{% block meta_copydoc %}{% endblock meta_copydoc %}
{% block meta_description %}{% endblock %}

{% block content %}
<section class="p-strip--grey is-shallow">
  <div class="u-fixed-width">
    <a href="/solutions">&lsaquo;&nbsp;My solutions</a>
    <h1 class="p-heading--2">
      Edit solution: {{ solution.title }}
    </h1>
    {% if solution.status == 'draft' and solution.revision == 1 %}
      <p>
        Add the remaining metadata for your solution.<br>
        Changes will need to be reviewed before being published.
      </p>
    {% elif solution.status == 'published' %}
      <p>
        Edit the metadata for your solution.
      </p>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="p-notification p-notification--{{ 'negative' if category == 'negative' else 'positive' }}" role="alert">
            <p class="p-notification__response">{{ message }}</p>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if errors %}
      <div class="p-notification--negative">
        <ul class="p-list p-notification__content u-no-padding--top" role="status">
          {% for e in errors %}
            <li class="p-list__item p-notification__status">{{ e.message }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
</section>

<section class="p-strip is-shallow">
  <div class="u-fixed-width">
    <form class="p-form" method="POST" action="{{ url_for('publisher.submit_edit_solution', hash=solution.hash) }}">

      <!-- Basic Information Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Basic Information</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="title">Title:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <div class="p-form-validation is-required">
            <input id="title"
              name="title"
              type="text"
              class="is-dense"
              required
              value="{{ (form_data.title if form_data else solution.title) | e }}"
            >
          </div>
          <p class="p-form-help-text">A human-readable title for your solution</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="summary">Summary:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <textarea
            id="summary"
            name="summary"
            class="is-dense"
            rows="4"
          >{{ (form_data.summary if form_data else (solution.summary if solution.summary is not none else '')) | e }}</textarea>
          <p class="p-form-help-text">A brief description of what your solution does</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="description">Description:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <textarea
            id="description"
            name="description"
            class="is-dense"
            rows="8"
          >{{ (form_data.description if form_data else (solution.description if solution.description is not none else '')) | e }}</textarea>
          <p class="p-form-help-text">Detailed description of your solution (Markdown supported)</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="get_started_url">Get Started URL:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="get_started_url"
            name="get_started_url"
            type="url"
            value="{{ (form_data.get_started_url if form_data else (solution.documentation.get_started if solution.documentation.get_started is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to getting started guide</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="icon">Icon URL:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="icon"
            name="icon"
            type="url"
            value="{{ (form_data.icon if form_data else (solution.media.icon if solution.media.icon is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to the solution icon image</p>
        </div>
      </div>

      <hr>

      <!-- Platform & Compatibility Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Platform & Compatibility</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="platform_version">Platform Versions:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <div id="platform-version-section">
            <div id="platform-version-list">
              {% if solution['deployable-on'] and solution['deployable-on'][0] and solution['deployable-on'][0].version %}
                {% for version in solution['deployable-on'][0].version %}
                  <div class="platform-version-item p-form--inline">
                    <button type="button" class="p-button--negative has-icon is-small remove-platform-version" aria-label="Remove version"><i class="p-icon--delete is-dark"></i></button>
                    <div class="p-form__group">
                      <div class="p-form__control">
                        <input class="p-form__control platform-version-input"
                          type="text"
                          name="platform_version[]"
                          value="{{ version | e }}"
                          placeholder="e.g., 1.25"
                        >
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <button type="button" id="add-platform-version" class="p-button--base">Add Platform Version</button>
            <p class="p-form-help-text">Add supported platform versions (e.g., Kubernetes versions)</p>
          </div>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="platform_prerequisites">Platform Prerequisites:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <div id="platform-prerequisites-section">
            <div id="platform-prerequisites-list">
              {% if solution['deployable-on'] and solution['deployable-on'][0] and solution['deployable-on'][0].prerequisites %}
                {% for prerequisite in solution['deployable-on'][0].prerequisites %}
                  <div class="platform-prerequisite-item p-form--inline">
                    <button type="button" class="p-button--negative has-icon is-small remove-platform-prerequisite" aria-label="Remove prerequisite"><i class="p-icon--delete is-dark"></i></button>
                    <div class="p-form__group">
                      <div class="p-form__control">
                        <input class="p-form__control platform-prerequisite-input"
                          type="text"
                          name="platform_prerequisites[]"
                          value="{{ prerequisite | e }}"
                          placeholder="e.g., GPU support"
                        >
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <button type="button" id="add-platform-prerequisite" class="p-button--base">Add Platform Prerequisite</button>
            <p class="p-form-help-text">Add a list of platform prerequisites (e.g., GPU support, storage requirements)</p>
          </div>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="juju_versions">Juju Versions:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <div id="juju-versions-section">
            <div id="juju-versions-list">
              {% if solution.compatibility and solution.compatibility.juju_versions %}
                {% for version in solution.compatibility.juju_versions %}
                  <div class="juju-version-item p-form--inline">
                    <button type="button" class="p-button--negative has-icon is-small remove-juju-version" aria-label="Remove version"><i class="p-icon--delete is-dark"></i></button>
                    <div class="p-form__group">
                      <div class="p-form__control">
                        <input class="p-form__control juju-version-input"
                          type="text"
                          name="juju_versions[]"
                          value="{{ version | e }}"
                          placeholder="e.g., 3.1"
                        >
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <button type="button" id="add-juju-version" class="p-button--base">Add Juju Version</button>
            <p class="p-form-help-text">Add supported Juju versions (e.g., 3.1, 2.9)</p>
          </div>
        </div>
      </div>

      <hr>

      <!-- Documentation Links Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Documentation Links</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="documentation_main">Main Documentation:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="documentation_main"
            name="documentation_main"
            type="url"
            value="{{ (form_data.documentation_main if form_data else (solution.documentation.main if solution.documentation.main is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to main documentation</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="documentation_source">Source Repository:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="documentation_source"
            name="documentation_source"
            type="url"
            value="{{ (form_data.documentation_source if form_data else (solution.documentation.source if solution.documentation.source is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to source code repository</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="terraform_modules">Terraform Modules:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="terraform_modules"
            name="terraform_modules"
            type="url"
            value="{{ (form_data.terraform_modules if form_data else (solution.terraform_modules if solution.terraform_modules is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to Terraform modules for this solution</p>
        </div>
      </div>

      <hr>

      <!-- Contact Information Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Contact Information</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="submit_bug_url">Submit a Bug URL:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="submit_bug_url"
            name="submit_bug_url"
            type="url"
            value="{{ (form_data.submit_bug_url if form_data else (solution.documentation.submit_a_bug if solution.documentation.submit_a_bug is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to submit bugs/issues (e.g., GitHub Issues, Launchpad)</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="community_discussion_url">Join the Discussion URL:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="community_discussion_url"
            name="community_discussion_url"
            type="url"
            value="{{ (form_data.community_discussion_url if form_data else (solution.documentation.community_discussion if solution.documentation.community_discussion is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to community discussions (e.g., Discourse, Matrix, Discord)</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <span>Maintainers:</span>
        </div>
        <div class="col-8 col-x-large-6">
          <div id="maintainers-section">
            <div id="maintainers-list">
              {% if solution.maintainers %}
                {% for maintainer in solution.maintainers %}
                  <div class="maintainer-item p-form--inline">
                    <button type="button" class="p-button--negative has-icon is-small remove-maintainer" aria-label="Remove {{ maintainer.email }}"><i class="p-icon--delete is-dark"></i></button>
                    <div class="p-form__group">
                      <div class="p-form__control">
                        <input class="p-form__control maintainer-email"
                          type="email"
                          name="maintainers_email[]"
                          value="{{ maintainer.email | e }}"
                          placeholder="john@canonical.com"
                        >
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <button type="button" id="add-maintainer" class="p-button--base">Add Maintainer</button>
            <p class="p-form-help-text">Add maintainers who help maintain this solution. Just enter their email addresses.</p>
          </div>
        </div>
      </div>

      <hr>

      <!-- Use Cases Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Use Cases</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <span>Use Cases:</span>
        </div>
        <div class="col-8 col-x-large-6">
          <div id="use-cases-section">
            <div id="use-cases-list">
              {% if solution.use_cases %}
                {% for use_case in solution.use_cases %}
                  <div class="use-case-item">
                    <div class="p-form--inline">
                      <button type="button" class="p-button--negative has-icon is-small remove-use-case" aria-label="Remove use case"><i class="p-icon--delete is-dark"></i></button>
                      <div class="p-form__group">
                        <div class="p-form__control">
                          <input class="p-form__control use-case-title"
                            type="text"
                            name="use_cases_title[]"
                            value="{{ use_case.title | e }}"
                            placeholder="Title: e.g., Log aggregation"
                          >
                        </div>
                      </div>
                    </div>
                    <div class="p-form__group">
                      <div class="p-form__control">
                        <textarea class="p-form__control use-case-description"
                          name="use_cases_description[]"
                          rows="2"
                          placeholder="Description: Describe this use case..."
                        >{{ use_case.description | e }}</textarea>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <button type="button" id="add-use-case" class="p-button--base">Add Use Case</button>
            <p class="p-form-help-text">Add use cases to describe how your solution can be used (maximum 3)</p>
          </div>
        </div>
      </div>

      <hr>

      <!-- Architecture Information Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Architecture Information</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="architecture_diagram_url">Architecture Diagram URL:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="architecture_diagram_url"
            name="architecture_diagram_url"
            type="url"
            value="{{ (form_data.architecture_diagram_url if form_data else (solution.media.architecture_diagram if solution.media.architecture_diagram is not none else '')) | e }}"
          >
          <p class="p-form-help-text">URL to architecture diagram</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="architecture_explanation">Architecture Description:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <textarea class="is-dense"
            id="architecture_explanation"
            name="architecture_explanation"
            rows="6"
          >{{ (form_data.architecture_explanation if form_data else (solution.documentation.architecture_explanation if solution.documentation.architecture_explanation is not none else '')) | e }}</textarea>
          <p class="p-form-help-text">Explanation of the solution architecture (Markdown supported)</p>
        </div>
      </div>

      <hr>

      <!-- Charms Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Charms</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="charm-search">Search for Charms:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <div class="p-search-and-filter" id="charm-search-filter">
            <div class="p-search-and-filter__search-container" aria-expanded="false" data-active="true" data-empty="true">
              <div class="p-search-and-filter__box" data-overflowing="false">
                <label class="u-off-screen" for="charm-search">Search for charms</label>
                <input autocomplete="off" class="p-search-and-filter__input" id="charm-search" name="charm-search" placeholder="Search for charms to add..." type="search" value="">
                <button alt="search" class="p-search-and-filter__search-button" type="button">Search</button>
              </div>
            </div>
            <div class="p-search-and-filter__panel" aria-hidden="true" id="charm-results-panel">
              <div class="p-filter-panel-section" id="charm-results-section" style="display: none;">
                <h5 class="p-filter-panel-section__heading">Available Charms</h5>
                <div class="p-filter-panel-section__chips" id="charm-results" aria-expanded="false">
                </div>
              </div>
              <div class="p-filter-panel-section" id="charm-no-results" style="display: none;">
                <p>No charms found. Try a different search term.</p>
              </div>
            </div>
          </div>
          <p class="p-form-help-text">Search and select charms that are part of this solution</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="manual-charm-name">Add Unpublished Charm:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <div class="p-form--inline">
            <div class="p-form__group">
              <input class="is-dense"
                id="manual-charm-name"
                type="text"
                placeholder="charm-name"
              >
              <button type="button" id="add-manual-charm" class="p-button--base">Add</button>
            </div>
          </div>
          <p class="p-form-help-text">Enter the slug of an unpublished charm to add it manually</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <span>Selected Charms:</span>
        </div>
        <div class="col-8 col-x-large-6">
          <div id="selected-charms">
            {% if solution.charms %}
              {% for charm in solution.charms %}
                <div data-charm-name="{{ charm.charm_name }}">
                  <button type="button" class="p-button--negative has-icon is-small charm-remove" aria-label="Remove {{ charm.charm_name }}"><i class="p-icon--delete is-dark"></i></button>
                  <span>{{ charm.charm_name }}</span>
                  <input type="hidden" name="charms[]" value="{{ charm.charm_name }}">
                </div>
              {% endfor %}
            {% endif %}
          </div>
          <p class="p-form-help-text">Selected charms will be included in the solution</p>
        </div>
      </div>

      <hr>

      <!-- Useful Links Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Useful Links</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <span>Useful Links:</span>
        </div>
        <div class="col-8 col-x-large-6">
          <div id="useful-links-section">
            <div id="useful-links-list">
              {% if solution.useful_links %}
                {% for link in solution.useful_links %}
                  <div class="useful-link-item p-form--inline">
                    <button type="button" class="p-button--negative has-icon is-small remove-useful-link" aria-label="Remove link"><i class="p-icon--delete is-dark"></i></button>
                    <div class="p-form__group">
                      <div class="p-form__control">
                        <input class="p-form__control useful-link-title"
                          type="text"
                          name="useful_links_title[]"
                          value="{{ link.title | e }}"
                          placeholder="Title: e.g., How to operate"
                        >
                      </div>
                    </div>
                    <div class="p-form__group">
                      <div class="p-form__control">
                        <input class="p-form__control useful-link-url"
                          type="url"
                          name="useful_links_url[]"
                          value="{{ link.url | e }}"
                          placeholder="URL: https://example.com"
                        >
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <button type="button" id="add-useful-link" class="p-button--base">Add Useful Link</button>
            <p class="p-form-help-text">Add links to documentation, guides, bug reports, discussions, etc. (maximum 3)</p>
          </div>
        </div>
      </div>

      <hr>

      <!-- Your Information Section -->
      <div class="u-fixed-width">
        <h4 class="p-heading--4">Your Information</h4>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="creator_email">Contact Email:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="creator_email"
            name="creator_email"
            type="email"
            class="is-dense"
            value="{{ (form_data.creator_email if form_data else (solution.creator.email if solution.creator.email is not none else '')) | e }}"
          >
          <p class="p-form-help-text">Contact email for this solution</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="mattermost_handle">Mattermost Handle:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="mattermost_handle"
            name="mattermost_handle"
            type="text"
            class="is-dense"
            value="{{ (form_data.mattermost_handle if form_data else (solution.creator.mattermost_handle if solution.creator.mattermost_handle is not none else '')) | e }}"
          >
          <p class="p-form-help-text">Optional: Your Mattermost handle for communication</p>
        </div>
      </div>

      <div class="p-form__group row">
        <div class="col-2">
          <label for="matrix_handle">Matrix Handle:</label>
        </div>
        <div class="col-8 col-x-large-6">
          <input class="is-dense"
            id="matrix_handle"
            name="matrix_handle"
            type="text"
            class="is-dense"
            value="{{ (form_data.matrix_handle if form_data else (solution.creator.matrix_handle if solution.creator.matrix_handle is not none else '')) | e }}"
          >
          <p class="p-form-help-text">Optional: Your Matrix handle for communication</p>
        </div>
      </div>

      <hr>

      <!-- Form Actions -->
      <div class="u-fixed-width">
        <div class="u-align--right">
          <a class="p-button--base" href="/solutions">Cancel</a>
          {% if solution.status == 'draft' and solution.revision == 1 %}
            <button type="submit" name="action" value="submit_for_review" class="p-button--positive">
              Submit metadata for review
            </button>
          {% elif solution.status == 'published' %}
            <button type="submit" name="action" value="update" class="p-button--positive">
              Update solution
            </button>
          {% else %}
            <button type="submit" name="action" value="save_draft" class="p-button--positive">
              Save draft
            </button>
          {% endif %}
        </div>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      </div>

    </form>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const charmSearchFilter = document.getElementById('charm-search-filter');
  const charmSearch = document.getElementById('charm-search');
  const charmResultsPanel = document.getElementById('charm-results-panel');
  const charmResults = document.getElementById('charm-results');
  const charmResultsSection = document.getElementById('charm-results-section');
  const charmNoResults = document.getElementById('charm-no-results');
  const selectedCharms = document.getElementById('selected-charms');
  const container = charmSearchFilter.querySelector('.p-search-and-filter__search-container');

  let searchTimeout;

  function togglePanel(container, panel, collapse) {
    if (typeof collapse === 'undefined') {
      collapse = panel.getAttribute('aria-hidden') !== 'false';
    }
    if (panel && container) {
      if (collapse) {
        panel.setAttribute('aria-hidden', 'true');
        container.setAttribute('aria-expanded', 'false');
      } else {
        panel.setAttribute('aria-hidden', 'false');
        container.setAttribute('aria-expanded', 'true');
      }
    }
  }

  charmSearch.addEventListener('focus', function(event) {
    togglePanel(container, charmResultsPanel, false);
  });

  charmSearch.addEventListener('blur', function(event) {
    setTimeout(() => {
      togglePanel(container, charmResultsPanel, true);
    }, 200);
  });

  charmSearch.addEventListener('input', function() {
    const query = this.value.trim();

    clearTimeout(searchTimeout);

    if (query.length < 2) {
      hideResults();
      return;
    }

    searchTimeout = setTimeout(() => {
      searchCharms(query);
    }, 300);
  });

  selectedCharms.addEventListener('click', function(e) {
    if (e.target.classList.contains('charm-remove') || e.target.closest('.charm-remove')) {
      const charmDiv = e.target.closest('[data-charm-name]');
      charmDiv.remove();
    }
  });

  charmSearchFilter.querySelector('.p-search-and-filter__search-button').addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (charmSearch.value.trim().length >= 2) {
      searchCharms(charmSearch.value.trim());
    }
  });

  function searchCharms(query) {
    fetch(`/all-charms?q=${encodeURIComponent(query)}&limit=15`)
      .then(response => response.json())
      .then(data => {
        const charms = data.charms || [];
        showResults(charms);
      })
      .catch(error => {
        console.error('Error searching charms:', error);
        showNoResults();
      });
  }

  function showResults(charms) {
    charmResults.innerHTML = '';
    if (charms.length > 0) {
      charms.forEach(charm => {
        const button = document.createElement('button');
        button.className = 'p-chip is-dense';
        button.type = 'button';
        button.innerHTML = `<span class="p-chip__value">${charm.name}</span>`;
        button.addEventListener('click', (e) => {
          e.preventDefault();
          addCharm(charm);
        });
        charmResults.appendChild(button);
      });
      charmResultsSection.style.display = 'block';
      charmNoResults.style.display = 'none';
    } else {
      showNoResults();
    }
  }

  function showNoResults() {
    charmResultsSection.style.display = 'none';
    charmNoResults.style.display = 'block';
  }

  function hideResults() {
    charmResultsSection.style.display = 'none';
    charmNoResults.style.display = 'none';
  }

  function addCharm(charm) {
    const existingCharms = getSelectedCharmNames();

    if (existingCharms.includes(charm.name)) {
      return;
    }

    const charmDiv = document.createElement('div');
    charmDiv.setAttribute('data-charm-name', charm.name);
    charmDiv.innerHTML = `
      <button type="button" class="p-button--negative has-icon is-small charm-remove" aria-label="Remove ${charm.name}"><i class="p-icon--delete is-dark"></i></button>
      <span>${charm.name}</span>
      <input type="hidden" name="charms[]" value="${charm.name}">
    `;

    selectedCharms.appendChild(charmDiv);
    charmSearch.value = '';
    hideResults();
  }

  function getSelectedCharmNames() {
    return Array.from(selectedCharms.querySelectorAll('[data-charm-name]')).map(div =>
      div.getAttribute('data-charm-name')
    );
  }

  const manualCharmInput = document.getElementById('manual-charm-name');
  const addManualCharmBtn = document.getElementById('add-manual-charm');

  function addManualCharm(charmName) {
    const existingCharms = getSelectedCharmNames();

    if (existingCharms.includes(charmName)) {
      return;
    }

    const charmDiv = document.createElement('div');
    charmDiv.setAttribute('data-charm-name', charmName);
    charmDiv.innerHTML = `
      <button type="button" class="p-button--negative has-icon is-small charm-remove" aria-label="Remove ${charmName}"><i class="p-icon--delete is-dark"></i></button>
      <span>${charmName}</span>
      <input type="hidden" name="charms[]" value="${charmName}">
    `;

    selectedCharms.appendChild(charmDiv);
    manualCharmInput.value = '';
  }

  addManualCharmBtn.addEventListener('click', () => {
    const charmName = manualCharmInput.value.trim();
    if (charmName) {
      addManualCharm(charmName);
    }
  });

  manualCharmInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const charmName = this.value.trim();
      if (charmName) {
        addManualCharm(charmName);
      }
    }
  });

  // Useful Links functionality
  const usefulLinksList = document.getElementById('useful-links-list');
  const addUsefulLinkBtn = document.getElementById('add-useful-link');
  const MAX_USEFUL_LINKS = 3;

  function createUsefulLinkItem() {
    const linkItem = document.createElement('div');
    linkItem.className = 'useful-link-item p-form--inline';
    linkItem.innerHTML = `
      <button type="button" class="p-button--negative has-icon is-small remove-useful-link" aria-label="Remove link"><i class="p-icon--delete is-dark"></i></button>
      <div class="p-form__group">
        <div class="p-form__control">
          <input class="p-form__control useful-link-title"
            type="text"
            name="useful_links_title[]"
            placeholder="Title: e.g., How to operate"
          >
        </div>
      </div>
      <div class="p-form__group">
        <div class="p-form__control">
          <input class="p-form__control useful-link-url"
            type="url"
            name="useful_links_url[]"
            placeholder="URL: https://example.com"
          >
        </div>
      </div>
    `;
    return linkItem;
  }

  function updateUsefulLinksButton() {
    const currentCount = usefulLinksList.querySelectorAll('.useful-link-item').length;
    addUsefulLinkBtn.style.display = currentCount >= MAX_USEFUL_LINKS ? 'none' : 'inline-block';
  }

  addUsefulLinkBtn.addEventListener('click', () => {
    const currentCount = usefulLinksList.querySelectorAll('.useful-link-item').length;
    if (currentCount < MAX_USEFUL_LINKS) {
      const newLinkItem = createUsefulLinkItem();
      usefulLinksList.appendChild(newLinkItem);
      updateUsefulLinksButton();
    }
  });

  usefulLinksList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-useful-link') || e.target.closest('.remove-useful-link')) {
      e.target.closest('.useful-link-item').remove();
      updateUsefulLinksButton();
    }
  });

  updateUsefulLinksButton();

  // Use Cases functionality
  const useCasesList = document.getElementById('use-cases-list');
  const addUseCaseBtn = document.getElementById('add-use-case');
  const MAX_USE_CASES = 3;

  function createUseCaseItem() {
    const caseItem = document.createElement('div');
    caseItem.className = 'use-case-item';
    caseItem.innerHTML = `
      <div class="p-form--inline">
        <div class="p-form__group">
          <div class="p-form__control">
            <input class="p-form__control use-case-title"
              type="text"
              name="use_cases_title[]"
              placeholder="Title: e.g., Log aggregation"
            >
          </div>
        </div>
        <button type="button" class="p-button--negative has-icon is-small remove-use-case" aria-label="Remove use case"><i class="p-icon--delete is-dark"></i></button>
      </div>
      <div class="p-form__group">
        <div class="p-form__control">
          <textarea class="p-form__control use-case-description"
            name="use_cases_description[]"
            rows="2"
            placeholder="Description: Describe this use case..."
          ></textarea>
        </div>
      </div>
    `;
    return caseItem;
  }

  function updateUseCasesButton() {
    const currentCount = useCasesList.querySelectorAll('.use-case-item').length;
    addUseCaseBtn.style.display = currentCount >= MAX_USE_CASES ? 'none' : 'inline-block';
  }

  addUseCaseBtn.addEventListener('click', () => {
    const currentCount = useCasesList.querySelectorAll('.use-case-item').length;
    if (currentCount < MAX_USE_CASES) {
      const newCaseItem = createUseCaseItem();
      useCasesList.appendChild(newCaseItem);
      updateUseCasesButton();
    }
  });

  useCasesList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-use-case') || e.target.closest('.remove-use-case')) {
      e.target.closest('.use-case-item').remove();
      updateUseCasesButton();
    }
  });

  updateUseCasesButton();

  // Maintainers functionality
  const maintainersList = document.getElementById('maintainers-list');
  const addMaintainerBtn = document.getElementById('add-maintainer');
  const MAX_MAINTAINERS = 5;

  function createMaintainerItem() {
    const maintainerItem = document.createElement('div');
    maintainerItem.className = 'maintainer-item p-form--inline';
    maintainerItem.innerHTML = `
      <button type="button" class="p-button--negative has-icon is-small remove-maintainer" aria-label="Remove maintainer"><i class="p-icon--delete is-dark"></i></button>
      <div class="p-form__group">
        <div class="p-form__control">
          <input class="p-form__control maintainer-email"
            type="email"
            name="maintainers_email[]"
            placeholder="john@canonical.com"
          >
        </div>
      </div>
    `;
    return maintainerItem;
  }

  function updateMaintainersButton() {
    const currentCount = maintainersList.querySelectorAll('.maintainer-item').length;
    addMaintainerBtn.style.display = currentCount >= MAX_MAINTAINERS ? 'none' : 'inline-block';
  }

  addMaintainerBtn.addEventListener('click', () => {
    const currentCount = maintainersList.querySelectorAll('.maintainer-item').length;
    if (currentCount < MAX_MAINTAINERS) {
      const newMaintainerItem = createMaintainerItem();
      maintainersList.appendChild(newMaintainerItem);
      updateMaintainersButton();
    }
  });

  maintainersList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-maintainer') || e.target.closest('.remove-maintainer')) {
      e.target.closest('.maintainer-item').remove();
      updateMaintainersButton();
    }
  });

  updateMaintainersButton();

  // Platform Versions functionality
  const platformVersionsList = document.getElementById('platform-version-list');
  const addPlatformVersionBtn = document.getElementById('add-platform-version');

  function createPlatformVersionItem() {
    const versionItem = document.createElement('div');
    versionItem.className = 'platform-version-item p-form--inline';
    versionItem.innerHTML = `
      <button type="button" class="p-button--negative has-icon is-small remove-platform-version" aria-label="Remove version"><i class="p-icon--delete is-dark"></i></button>
      <div class="p-form__group">
        <div class="p-form__control">
          <input class="p-form__control platform-version-input"
            type="text"
            name="platform_version[]"
            placeholder="e.g., 1.25"
          >
        </div>
      </div>
    `;
    return versionItem;
  }

  addPlatformVersionBtn.addEventListener('click', () => {
    const newVersionItem = createPlatformVersionItem();
    platformVersionsList.appendChild(newVersionItem);
  });

  platformVersionsList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-platform-version') || e.target.closest('.remove-platform-version')) {
      e.target.closest('.platform-version-item').remove();
    }
  });

  // Platform Prerequisites functionality
  const platformPrerequisitesList = document.getElementById('platform-prerequisites-list');
  const addPlatformPrerequisiteBtn = document.getElementById('add-platform-prerequisite');

  function createPlatformPrerequisiteItem() {
    const prerequisiteItem = document.createElement('div');
    prerequisiteItem.className = 'platform-prerequisite-item p-form--inline';
    prerequisiteItem.innerHTML = `
      <button type="button" class="p-button--negative has-icon is-small remove-platform-prerequisite" aria-label="Remove prerequisite"><i class="p-icon--delete is-dark"></i></button>
      <div class="p-form__group">
        <div class="p-form__control">
          <input class="p-form__control platform-prerequisite-input"
            type="text"
            name="platform_prerequisites[]"
            placeholder="e.g., GPU support"
          >
        </div>
      </div>
    `;
    return prerequisiteItem;
  }

  addPlatformPrerequisiteBtn.addEventListener('click', () => {
    const newPrerequisiteItem = createPlatformPrerequisiteItem();
    platformPrerequisitesList.appendChild(newPrerequisiteItem);
  });

  platformPrerequisitesList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-platform-prerequisite') || e.target.closest('.remove-platform-prerequisite')) {
      e.target.closest('.platform-prerequisite-item').remove();
    }
  });

  // Juju Versions functionality
  const jujuVersionsList = document.getElementById('juju-versions-list');
  const addJujuVersionBtn = document.getElementById('add-juju-version');

  function createJujuVersionItem() {
    const versionItem = document.createElement('div');
    versionItem.className = 'juju-version-item p-form--inline';
    versionItem.innerHTML = `
      <button type="button" class="p-button--negative has-icon is-small remove-juju-version" aria-label="Remove version"><i class="p-icon--delete is-dark"></i></button>
      <div class="p-form__group">
        <div class="p-form__control">
          <input class="p-form__control juju-version-input"
            type="text"
            name="juju_versions[]"
            placeholder="e.g., 3.1"
          >
        </div>
      </div>
    `;
    return versionItem;
  }

  addJujuVersionBtn.addEventListener('click', () => {
    const newVersionItem = createJujuVersionItem();
    jujuVersionsList.appendChild(newVersionItem);
  });

  jujuVersionsList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-juju-version') || e.target.closest('.remove-juju-version')) {
      e.target.closest('.juju-version-item').remove();
    }
  });

});
</script>
{% endblock %}